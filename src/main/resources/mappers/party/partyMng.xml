<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.proj.pots.party.dao.IPartyMngDAO">
	
	<insert id="insertParty" parameterType="PartyRegDTO" useGeneratedKeys="true">
		INSERT INTO party (id, party_regdate, party_service, party_subservice, party_title, party_member, party_id, party_pw, party_tel, party_start, party_end, party_charge, party_adult, party_notice, party_available)
		VALUES (
		#{id},
		#{party_regdate}, 		
		#{party_service}, 		
		#{party_subservice}, 	
		#{party_title}, 			
		#{party_member}, 			
		#{party_id}, 			
		#{party_pw}, 			
		#{party_tel}, 			
		#{party_start}, 			
		#{party_end}, 			
		#{party_charge}, 		
		#{party_adult}, 			
		#{party_notice}, 		
		#{party_available})   
	</insert>
	
	<select id="partyList" resultType="PartyListDTO">
		SELECT a.*, b.party_count AS party_now_member 
		FROM 
			(SELECT * FROM party WHERE id=#{id}) 
			a 
		LEFT JOIN 
			(SELECT party_num, count(*) AS party_count FROM party_member GROUP BY party_num) 
			b 
		ON a.party_num = b.party_num;
	</select>
	
	<select id="partySearch" parameterType="Map" resultType="PartyListDTO">
		SELECT a.*, b.party_count AS party_now_member 
			FROM 
				(SELECT * FROM party WHERE id=#{id} 
					<choose>
						<when test="sel1 == 'ser'">AND party_service=#{keynum}</when>
						<when test="sel1 == 'sub'">AND party_subservice=#{keynum}</when>
					</choose>
					<choose>
						<when test="sel2 == 'num'">AND party_num CONCAT('%',#{keyword},'%')</when>
						<when test="sel2 == 'id'">AND party_id CONCAT('%',#{keyword},'%')</when>
					</choose>
					ORDER BY party_num DESC
				) a 
			LEFT JOIN 
				(SELECT party_num, count(*) AS party_count FROM party_member GROUP BY party_num) 
				b 
			ON a.party_num = b.party_num ;
	</select>
	
	
	
</mapper>