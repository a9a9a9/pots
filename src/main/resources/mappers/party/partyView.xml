<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.proj.pots.party.dao.IPartyViewDAO">

	<select id="comment" parameterType="String" resultType="PartyCommentDTO">
	 	SELECT a.nick, a.comment_date, a.comment, a.comment_private, b.party_title
	 	FROM party_comment as a
	 	JOIN party as b
	 	ON a.party_num = b.party_num AND b.id = #{id} AND a.id != #{id}<!-- id 세션 값 --> 
	 	ORDER BY comment_date DESC 
	 </select>
	 
	 <select id="selectAccount" parameterType="String" resultType="PartnerInfoDTO">
	 	SELECT * FROM partner_info WHERE id = #{id}
	 </select> 
	 
	 <insert id="insertAccount" parameterType="PartnerInfoDTO">
	 	INSERT INTO partner_info
	 	VALUES (#{id}, #{personal_num}, #{account_name}, #{account_num})
	 </insert>
	 
	 <insert id="insertPartyMember" parameterType="PartyMemberDTO">
	 	INSERT INTO party_member(id, nick, party_num, mycharge, mystartday)
	 	VALUES (#{id}, #{nick}, #{party_num}, #{mycharge}, NOW()) ;
	 </insert>
	 
	 <update id="updateAccount" parameterType="PartnerInfoDTO">
	 	UPDATE partner_info 
	 	SET personal_num=#{personal_num}, account_name=#{account_name}, account_num=#{account_num} 
	 	WHERE id = #{id}
	 </update>
	 
	 <select id="selectParty" parameterType="int" resultType="PartyRegDTO">
	 	SELECT * FROM party WHERE party_num = #{party_num}
	 </select> 
	 
	 <select id="partyDay" parameterType="int" resultType="PartyRegDTO">
	 	SELECT TIMESTAMPDIFF(DAY, party_start, party_end) as diff FROM party WHERE party_num = #{party_num};
	 </select>
	 
	 <select id="partyAvailableChk" resultType="PartyListDTO">
	 SELECT a.party_num, a.party_member, b.party_count AS party_now_member 
		FROM 
			(SELECT * FROM party WHERE party_num=#{party_num}) 
			a 
		LEFT JOIN 
			(SELECT party_num, count(*) AS party_count FROM party_member GROUP BY party_num) 
			b 
		ON a.party_num = b.party_num;
	 </select> 
	 
	 <update id="updateParty">
	 	UPDATE party SET party_available='0' WHERE party_num=#{party_num}
	 </update>
			 	 
</mapper>